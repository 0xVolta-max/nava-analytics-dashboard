<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Altcha Test Page</title>
    <script type="module" crossorigin src="http://localhost:8081/assets/index.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .status {
            margin: 20px 0;
            padding: 10px;
            border-radius: 4px;
        }
        .status.loading { background: #e3f2fd; color: #1976d2; }
        .status.success { background: #e8f5e8; color: #2e7d32; }
        .status.error { background: #ffebee; color: #c62828; }
        .logs {
            background: #f8f8f8;
            padding: 15px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 20px;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🧪 Altcha Integration Test</h1>

        <div class="test-section">
            <h2>Test 1: CSRF Token Fetch</h2>
            <button onclick="testCsrfToken()">Test CSRF Token</button>
            <div id="csrf-status" class="status">Not tested</div>
        </div>

        <div class="test-section">
            <h2>Test 2: Altcha Challenge Fetch</h2>
            <button onclick="testAltchaChallenge()">Test Challenge</button>
            <div id="challenge-status" class="status">Not tested</div>
        </div>

        <div class="test-section">
            <h2>Test 3: Altcha Widget</h2>
            <div id="altcha-widget-container"></div>
            <div id="widget-status" class="status">Not loaded</div>
        </div>

        <div class="logs">
            <strong>Console Logs:</strong>
            <div id="log-container"></div>
        </div>
    </div>

    <script type="module">
        // Import the AltchaWidget component
        import AltchaWidget from './src/components/AltchaWidget.tsx?raw';

        let csrfToken = null;
        let challengeData = null;

        // Override console.log to show in our log container
        const originalLog = console.log;
        const originalError = console.error;

        console.log = function(...args) {
            originalLog.apply(console, args);
            logToContainer('LOG', args.join(' '));
        };

        console.error = function(...args) {
            originalError.apply(console, args);
            logToContainer('ERROR', args.join(' '));
        };

        function logToContainer(type, message) {
            const container = document.getElementById('log-container');
            const timestamp = new Date().toLocaleTimeString();
            container.innerHTML += `<div>[${timestamp}] ${type}: ${message}</div>`;
            container.scrollTop = container.scrollHeight;
        }

        // Test CSRF token fetch
        window.testCsrfToken = async function() {
            const statusDiv = document.getElementById('csrf-status');
            statusDiv.className = 'status loading';
            statusDiv.textContent = 'Fetching CSRF token...';

            try {
                const response = await fetch('/api/csrf-token');
                const data = await response.json();

                if (data.success) {
                    csrfToken = data.token;
                    statusDiv.className = 'status success';
                    statusDiv.textContent = `✅ CSRF Token received: ${data.token.substring(0, 16)}...`;
                } else {
                    throw new Error(data.error || 'Unknown error');
                }
            } catch (error) {
                statusDiv.className = 'status error';
                statusDiv.textContent = `❌ Error: ${error.message}`;
            }
        };

        // Test Altcha challenge fetch
        window.testAltchaChallenge = async function() {
            if (!csrfToken) {
                alert('Please test CSRF token first!');
                return;
            }

            const statusDiv = document.getElementById('challenge-status');
            statusDiv.className = 'status loading';
            statusDiv.textContent = 'Fetching Altcha challenge...';

            try {
                const response = await fetch('/api/altcha-challenge', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-csrf-token': csrfToken
                    },
                    body: JSON.stringify({ action: 'login' })
                });

                const data = await response.json();

                if (data.success) {
                    challengeData = data;
                    statusDiv.className = 'status success';
                    statusDiv.textContent = `✅ Challenge received: ${data.challenge.substring(0, 16)}...`;
                } else {
                    throw new Error(data.error || 'Unknown error');
                }
            } catch (error) {
                statusDiv.className = 'status error';
                statusDiv.textContent = `❌ Error: ${error.message}`;
            }
        };

        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 Altcha Test Page loaded');
            console.log('🔗 API Base URL: http://localhost:8081');

            // Auto-test CSRF token after 1 second
            setTimeout(() => {
                testCsrfToken();
            }, 1000);
        });
    </script>
</body>
</html>
